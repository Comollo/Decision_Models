---
title: "LDE dataset"
author: "Adreose Eugenio,<br>Caldara Gabriele,<br>Comotto Federico,<br>Scardovelli Massimiliano"
date: "09 luglio 2018"
output:
  html_document:
    code_download: yes
    df_print: paged
    highlight: textmate
    theme: spacelab
    toc: yes
    toc_depth: 5
---

```{r, include=FALSE}
library(dplyr)
library(lubridate)
library(funModeling)
library(ggplot2)
options(scipen = 999)
```

##Dataset

```{r}
slot <- readxl::read_excel("Lucky Duck Entertainment revenue 2013.xls", na = c(".", "NA", "NaN"))
str(slot)
```

Status Dataframe
```{r}
status = df_status(slot, print_results = F)
sort(unique(slot$Month)) #12 month
knitr::kable(status)
```

##Categorization

Creazione del dataset che verrà utilizzato per i 12 modelli. L'aggregazione avviene per categoria (MachineType+Denomination) per ogni mese in ogni sezione dei 2 Casinò.


```{r}
df <- slot %>%
  group_by(Month, Casino, Section, MachineType, Denomination) %>%
  summarise(numero_macchine    = sum(NoMachines),
            ricavi_totali      = sum(GrossRevenue),
            ricavo_unitario    = ricavi_totali/numero_macchine,
            giocate_totali     = sum(Plays),
            giocate_unitarie   = round(giocate_totali/numero_macchine),
            ricavo_per_giocata = ricavi_totali/giocate_totali) %>%
  arrange(Month, Section, MachineType, Denomination) %>%
  mutate(tipo = paste0(MachineType, "_", Denomination)) 
knitr::kable(head(df))
```

A seguito del processo di aggregazione, qual è il numero massimo di categorie per LDE?
```{r}
cat("Max number of categories:", nrow(df %>%
  group_by(tipo) %>%
  summarise(n = n())))
```

Quali sono?
```{r}
knitr::kable(df %>%
  group_by(tipo) %>%
  summarise(n = n()) %>%
  select(tipo))
```

Qual è il numero massimo di categorie in ciascun Casinò?
```{r}
Casino = df %>% group_by(tipo, Casino) %>%
  summarise(n = n()) %>%
  arrange(Casino)
cat("Max number of categories for Aries:", nrow(Casino %>% filter(Casino == "Aries")), fill = T)
cat("Max number of categories for Libra:", nrow(Casino %>% filter(Casino == "Libra")))
```

Quante categorie (in media) ci sono in ciascuna Sezione dei 2 Casinò?
```{r}
knitr::kable(df %>% group_by(Casino, Section, Month) %>%
  summarise(n = n()) %>%
  arrange(Casino, Section) %>%
  group_by(Casino, Section) %>%
  summarise(Numero_medio_categorie = mean(n), Varianza_numero_categorie = sqrt(var(n))))
```

Quante categorie (in media) ci sono in ciascun mese per i 2 Casinò?
```{r}
knitr::kable(df %>% group_by(Casino, Section, Month) %>%
  summarise(n = n()) %>%
  arrange(Casino, Section) %>%
  group_by(Casino, Month) %>%
  summarise(Numero_medio_categorie = mean(n), Varianza_numero_categorie = sqrt(var(n))))
```

##Data Visualization (Exploration)
Al fine di sottolineare alcuni aspetti denotati in fase di esplorazione verranno creati dei dataset appositi.

```{r}
tre <- df %>% select(Section, tipo, ricavo_unitario)
ggplot(data = tre, aes(x = tre$tipo, y = tre$ricavo_unitario, colour = tre$Section)) +
  geom_point( size=4) +
  labs(x="Categoria", y="Ricavo unitario", colour = "Sezione")
  theme_light()
```
Dal grafico, si evince come la sezione Entance sia tendenzialmente legata a ricavi unitari più bassi rispetto alle altre sezioni per ciascuna categoria. Inoltre si può notare come la tipologia di slot reel venga valorizzata se posizionata nella sezione Boundary del Casinò, in quanto restituisce ricavi unitari maggiori. Per quanto riguarda le slot di tipo Video, osserviamo i ricavi maggiori quando sono disposte nelle sezioni Interior e Restaurant Plaza. Le slot Vpoker forniscono un ricavo unitario relativamente basso ed equidistribuito per le diverse sezioni. Infine si può asserire che slot da cui si guadagna maggiormente sono quelle con denomination pari a 0.05, 0.25 e 1.

Prima dimensione: il tempo
```{r}
ricavi_mese = df %>% 
  group_by(Month) %>%
  summarise(ricavo_medio_totale = mean(ricavi_totali),
            ricavo_medio_unitario = mean(ricavo_unitario),
            numero_macchine_medie = mean(numero_macchine),
            varianza_macchine = sqrt(var(numero_macchine)))

ggplot(data=ricavi_mese, aes(x=ricavi_mese$Month, y = ricavi_mese$ricavo_medio_unitario)) +
  geom_line(alpha=.5, size=1, color="#880011") +
  ggtitle("Ricavi per Mese di LDE") +
  labs(x="Mese", y="Ricavo medio unitario") +
  theme_classic()

ricavi_mese$Month = as.factor(ricavi_mese$Month)

ggplot(data=ricavi_mese, aes(x=ricavi_mese$numero_macchine_medie,
                             y=ricavi_mese$ricavo_medio_totale,
                             colour = Month)) +
  geom_point(alpha=.4, size=4) +
  ggtitle("PiÃ¹ macchine hai piÃ¹ guadagni? In linea di massima SI!") +
  labs(x="Numero medio macchine", y="Ricavi medi totali") + 
  theme_minimal()

ggplot(data=ricavi_mese, aes(x=ricavi_mese$numero_macchine_medie,
                             y=ricavi_mese$ricavo_medio_unitario,
                             colour = Month)) +
  geom_point(alpha=.4, size=4) +
  ggtitle("Tante macchine non significa ricavi unitari elevati!") +
  labs(x="Numero medio macchine", y="Ricavi medi unitari") + 
  theme_minimal()
```
 
Seconda dimensione: categorie
```{r}
ricavi_categoria = df %>%
  group_by(Denomination, MachineType) %>%
  summarise(ricavo_medio_unitario = mean(ricavo_unitario)) %>%
  mutate(type = paste0(Denomination,sep = "_", MachineType))

ggplot(data=ricavi_categoria, aes(x=ricavi_categoria$type, y = sort(ricavi_categoria$ricavo_medio_unitario))) +
  geom_bar(stat="identity", fill = "firebrick3" ) +
  ggtitle("Ricavi per Categoria di LDE") +
  labs(x="Categoria", y="Ricavo medio unitario") +
  theme_classic() 

```

Terza dimensione: le sezioni
```{r}
ricavi_sezione = df %>% 
  group_by(Section) %>%
  summarise(ricavo_medio_unitario = mean(ricavo_unitario))

ggplot(data=ricavi_sezione, aes(x=ricavi_sezione$Section, y = sort(ricavi_sezione$ricavo_medio_unitario))) +
  geom_bar(stat="identity", fill = "forestgreen", width = 0.4 ) +
  geom_text(aes(label = round(ricavi_sezione$ricavo_medio_unitario)), nudge_y = 700 ) +
  ggtitle("Ricavi per Sezione di LDE") +
  labs(x="Sezione", y="Ricavo medio unitario") +
  theme_classic() 

```

Quarta dimensione: i Casinò
```{r}
ricavi_casino = df %>% 
  group_by(Casino) %>%
  summarise(ricavo_medio_unitario = mean(ricavo_unitario))

ggplot(data=ricavi_casino, aes(x=ricavi_casino$Casino, y = ricavi_casino$ricavo_medio_unitario)) +
  geom_bar(stat="identity", fill = "blue", width = 0.4 ) +
  geom_text(aes(label = round(ricavi_casino$ricavo_medio_unitario)), nudge_y = 700 ) +
  ggtitle("Ricavi per Casino di LDE") +
  labs(x="Casino", y="Ricavo medio unitario") +
  theme_classic()
```

Dato che i ricavi unitari cambiano in funzione delle 4 dimensioni analizzate possiamo affermare che ha senso creare un modello per ciascun mese che cerchi di massimizzare i ricavi unitari delle categorie presenti in ciascuna sezione.

##Vincolo numero 3: Motivazione

```{r}
ggplot(data=df, aes(x=df$giocate_totali, y = df$numero_macchine)) +
  geom_point(alpha=.5, size=3, color="#880011") +
  ggtitle("Più macchine ci sono più si gioca? Si") +
  labs(x="Giocate Totali", y="Numero di Macchine") +
  theme_classic()

cat("The Correlation between 'Giocate Totali' and 'Numero Macchine' is:",cor(df$giocate_totali, df$numero_macchine))
```

Ma è vero per ogni mese?
```{r}
correlazione = list()
m = sort(unique(ymd(df$Month)))
for(i in 1:12) {
  month = df %>% filter(Month == m[i])
  correlazione[as.character(m[i])] = cor(month$giocate_totali, month$numero_macchine)
}
correlazione
```

Si!
